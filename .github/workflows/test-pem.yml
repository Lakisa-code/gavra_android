name: Test PEM Key

on:
  workflow_dispatch:

jobs:
  test-key:
    runs-on: macos-latest
    
    steps:
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/private_keys
          # Try method 1: Direct (no base64)
          printf '%s' "${{ secrets.APPSTORE_API_KEY_P8 }}" > ~/private_keys/AuthKey_direct.p8
          # Try method 2: Base64 decode
          printf '%s' "${{ secrets.APPSTORE_API_KEY_P8 }}" | base64 -d > ~/private_keys/AuthKey_decoded.p8
          
          echo "=== Method 1: Direct (first 3 lines) ==="
          head -3 ~/private_keys/AuthKey_direct.p8 || echo "Failed"
          echo ""
          echo "=== Method 2: Base64 decoded (first 3 lines) ==="
          head -3 ~/private_keys/AuthKey_decoded.p8 || echo "Failed"
          echo ""
          echo "=== File sizes ==="
          ls -lh ~/private_keys/

      - name: Install Codemagic CLI
        run: |
          brew install pipx
          pipx install codemagic-cli-tools
          pipx ensurepath

      - name: Test API Connection
        run: |
          echo "=== Testing with DIRECT method ==="
          app-store-connect apps list \
            --issuer-id "${{ secrets.APPSTORE_ISSUER_ID }}" \
            --key-id "${{ secrets.APPSTORE_KEY_ID }}" \
            --private-key ~/private_keys/AuthKey_direct.p8 \
            --json 2>&1 | head -5 || echo "Direct method failed"
          
          echo ""
          echo "=== Testing with BASE64 DECODED method ==="
          app-store-connect apps list \
            --issuer-id "${{ secrets.APPSTORE_ISSUER_ID }}" \
            --key-id "${{ secrets.APPSTORE_KEY_ID }}" \
            --private-key ~/private_keys/AuthKey_decoded.p8 \
            --json 2>&1 | head -5 || echo "Decoded method failed"
          
          echo ""
          echo "âœ… Test completed!"
