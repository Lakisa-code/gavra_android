name: gavra google alpha

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //; s/+.*//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          cache: true

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Decode Google Play Key
        run: |
          printf "%s" "${{ secrets.GOOGLE_PLAY_KEY_B64 }}" | base64 -d > $GITHUB_WORKSPACE/android/play-store-key.json
        shell: bash

      - name: Decode Android Keystore
        run: |
          printf "%s" "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 -d > $GITHUB_WORKSPACE/android/app/gavra-release-key-production.keystore
        shell: bash

      - name: Create key.properties
        run: |
          mkdir -p $GITHUB_WORKSPACE/android
          cat > $GITHUB_WORKSPACE/android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=$GITHUB_WORKSPACE/android/app/gavra-release-key-production.keystore
          EOF
        shell: bash

      - name: Create .env file
        run: |
          cat > $GITHUB_WORKSPACE/.env << EOF
          ${{ secrets.ENV_FILE_CONTENT }}
          EOF
        shell: bash

      - name: Create Firebase and Huawei services files
        run: |
          mkdir -p $GITHUB_WORKSPACE/android/app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > $GITHUB_WORKSPACE/android/app/google-services.json
          echo '${{ secrets.AGCONNECT_SERVICES_JSON }}' > $GITHUB_WORKSPACE/android/app/agconnect-services.json
        shell: bash

      - name: Get dependencies
        run: flutter pub get

      - name: Build AAB (Android App Bundle)
        run: |
          flutter build appbundle \
            --release \
            --target-platform android-arm64 \
            --obfuscate \
            --split-debug-info=build/app/outputs/mapping

      - name: Upload AAB to Google Play (Alpha - Closed Testing)
        env:
          GOOGLE_PLAY_KEY_B64: ${{ secrets.GOOGLE_PLAY_KEY_B64 }}
        run: |
          # Decode key
          echo "$GOOGLE_PLAY_KEY_B64" | base64 -d > google-play-key.json
          
          # Install Node dependencies
          npm install googleapis
          
          # Create upload script
          cat > upload.js << 'UPLOADEOF'
          const { google } = require('googleapis');
          const fs = require('fs');
          
          const PACKAGE_NAME = 'com.gavra013.gavra_android';
          const AAB_PATH = 'build/app/outputs/bundle/release/app-release.aab';
          const TRACK = 'alpha';
          const credentials = JSON.parse(fs.readFileSync('google-play-key.json', 'utf8'));
          
          async function uploadAAB() {
            const auth = new google.auth.GoogleAuth({
              credentials,
              scopes: ['https://www.googleapis.com/auth/androidpublisher']
            });
          
            const androidPublisher = google.androidpublisher({
              version: 'v3',
              auth: await auth.getClient()
            });
          
            try {
              console.log('üì± Starting upload to Alpha (Closed Testing)...\n');
              
              // Create edit
              const editRes = await androidPublisher.edits.insert({
                packageName: PACKAGE_NAME,
                requestBody: {}
              });
              const editId = editRes.data.id;
              console.log('‚úÖ Edit session created:', editId);
          
              // Upload bundle
              const bundleRes = await androidPublisher.edits.bundles.upload({
                packageName: PACKAGE_NAME,
                editId: editId,
                media: {
                  mimeType: 'application/octet-stream',
                  body: fs.createReadStream(AAB_PATH)
                }
              });
              
              const versionCode = bundleRes.data.versionCode;
              console.log('‚úÖ Bundle uploaded. Version Code:', versionCode);
          
              // Update alpha track with inProgress status (for closed testing)
              await androidPublisher.edits.tracks.update({
                packageName: PACKAGE_NAME,
                editId: editId,
                track: TRACK,
                requestBody: {
                  track: TRACK,
                  releases: [{
                    name: 'Closed Testing Build v' + versionCode,
                    versionCodes: [versionCode.toString()],
                    status: 'inProgress',
                    releaseNotes: [{
                      language: 'sr-RS',
                      text: 'Alpha Closed Testing Build'
                    }]
                  }]
                }
              });
              console.log('‚úÖ Alpha track updated (status: inProgress - Closed Testing)');
          
              // Commit edit
              const commitRes = await androidPublisher.edits.commit({
                packageName: PACKAGE_NAME,
                editId: editId
              });
              console.log('‚úÖ Changes committed successfully!\n');
              console.log('üìä Commit details:', commitRes.data);
              
            } catch (error) {
              console.error('‚ùå Error:', error.message);
              if (error.errors) {
                error.errors.forEach(e => console.error('   -', e.message));
              }
              process.exit(1);
            }
          }
          
          uploadAAB();
          UPLOADEOF
          
          node upload.js
        shell: bash

      - name: ‚úÖ Upload complete
        run: |
          echo "üéâ Successfully built and uploaded to Google Play Alpha (Closed Testing)!"
          echo ""
          echo "üì¶ Build Details:"
          echo "  - Package: com.gavra013.gavra_android"
          echo "  - Track: alpha"
          echo "  - Type: Closed Testing"
          echo "  - Status: Ready for testers"
          echo ""
          echo "‚è≠Ô∏è  Next steps:"
          echo "  1. Review in Google Play Console"
          echo "  2. Notify testers about new build"
          echo "  3. Monitor feedback and crashes"
