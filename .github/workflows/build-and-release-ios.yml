name: üçé Build & Release to TestFlight (Closed Testing)

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: üì¶ Get dependencies
        run: flutter pub get

      - name: üîß Setup Fastlane
        run: |
          brew install fastlane
          cd ios
          fastlane setup_ci
          cd ..

      - name: üîê Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APPSTORE_API_KEY_P8 }}" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8

      - name: üî® Build iOS App (IPA)
        run: |
          flutter build ipa \
            --release \
            --verbose
        env:
          JAVA_TOOL_OPTIONS: "-Xmx4096m"

      - name: üì§ Upload to TestFlight via Fastlane
        run: |
          cd ios
          fastlane pilot upload \
            --ipa ../build/ios/ipa/gavra_android.ipa \
            --api_key_path ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8 \
            --api_key_id ${{ secrets.APPSTORE_KEY_ID }} \
            --api_issuer_id ${{ secrets.APPSTORE_ISSUER_ID }} \
            --skip_waiting_for_build_processing true \
            --changelog "TestFlight Build - Closed Testing"
          cd ..

      - name: ‚úÖ Upload complete
        run: |
          echo "üéâ Successfully built and uploaded to TestFlight!"
          echo ""
          echo "üì¶ Build Details:"
          echo "  - App: Gavra 013"
          echo "  - Version: 6.0.54 (424)"
          echo "  - Track: TestFlight (Closed Testing)"
          echo "  - Status: Ready for review"
          echo ""
          echo "‚è≠Ô∏è  Next steps:"
          echo "  1. Review in App Store Connect"
          echo "  2. Approve build in TestFlight"
          echo "  3. Notify testers"
