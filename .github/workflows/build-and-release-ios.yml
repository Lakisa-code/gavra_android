name: üçé Build & Release to TestFlight (Closed Testing)

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: üì¶ Get dependencies
        run: flutter pub get

      - name: üîê Setup App Store Connect Credentials
        env:
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_API_KEY_P8: ${{ secrets.APPSTORE_API_KEY_P8 }}
        run: |
          # Create directory for API keys
          mkdir -p ~/.appstoreconnect/private_keys
          
          # Decode and save API key
          echo "$APPSTORE_API_KEY_P8" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${APPSTORE_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${APPSTORE_KEY_ID}.p8
          
          echo "‚úÖ App Store Connect API Key Setup Complete"

      - name: üî® Build iOS App (IPA)
        run: |
          flutter build ipa \
            --release \
            --no-codesign \
            --verbose
        env:
          JAVA_TOOL_OPTIONS: "-Xmx4096m"

      - name: üì§ Upload to TestFlight via Transporter
        run: |
          # Install Transporter (Apple's official upload tool)
          xcrun altool --validate-app \
            -f build/ios/ipa/gavra_android.ipa \
            -t ios \
            -u ${{ secrets.APPSTORE_USERNAME }} \
            -p ${{ secrets.APPSTORE_APP_PASSWORD }}
          
          xcrun altool --upload-app \
            -f build/ios/ipa/gavra_android.ipa \
            -t ios \
            -u ${{ secrets.APPSTORE_USERNAME }} \
            -p ${{ secrets.APPSTORE_APP_PASSWORD }}

      - name: ‚úÖ Upload complete
        run: |
          echo "üéâ Successfully built and uploaded to TestFlight!"
          echo ""
          echo "üì¶ Build Details:"
          echo "  - App: Gavra 013"
          echo "  - Version: 6.0.54 (424)"
          echo "  - Track: TestFlight (Closed Testing)"
          echo "  - Status: Ready for review"
          echo ""
          echo "‚è≠Ô∏è  Next steps:"
          echo "  1. Review in App Store Connect"
          echo "  2. Approve build in TestFlight"
          echo "  3. Notify testers"
