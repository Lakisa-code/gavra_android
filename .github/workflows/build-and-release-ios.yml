name: üçé Build & Release to TestFlight (Closed Testing)

on:
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: üì¶ Get dependencies
        run: flutter pub get

      - name: üîê Setup App Store Connect API Key
        run: |
          mkdir -p ~/private_keys
          echo "${{ secrets.APPSTORE_API_KEY_P8 }}" > ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
          chmod 600 ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8

      - name: üîê Setup iOS Code Signing
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

      - name: üì¶ Setup provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: üî® Build iOS App
        run: |
          flutter build ipa \
            --release \
            --export-options-template=ios/ExportOptions.plist \
            --verbose

      - name: üì§ Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: 'build/ios/ipa/gavra_android.ipa'
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_KEY_P8 }}
          bundle-id: 'com.gavra013.gavra-android'

      - name: ‚úÖ Upload complete
        run: |
          echo "üéâ Successfully built and uploaded to TestFlight!"
          echo ""
          echo "üì¶ Build Details:"
          echo "  - App: Gavra 013"
          echo "  - Track: TestFlight (Closed Testing)"
          echo "  - Status: Ready for testers"
          echo ""
          echo "‚è≠Ô∏è  Next steps:"
          echo "  1. Review in App Store Connect"
          echo "  2. Notify testers about new build"
          echo "  3. Monitor TestFlight feedback"
