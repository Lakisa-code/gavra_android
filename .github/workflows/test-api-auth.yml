name: Test App Store Connect Auth

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Codemagic CLI
        run: |
          brew install pipx
          pipx install codemagic-cli-tools
          pipx ensurepath

      - name: Test with DIRECT secret
        run: |
          echo "=== Testing with DIRECT secret (as stored) ==="
          mkdir -p ~/private_keys
          
          # First 50 chars to see format
          echo "Secret first 50 chars:"
          printf '%s' "${{ secrets.APPSTORE_API_KEY_P8 }}" | head -c 50
          echo ""
          echo ""
          
          # Save as direct
          printf '%s' "${{ secrets.APPSTORE_API_KEY_P8 }}" > ~/private_keys/test_direct.p8
          
          echo "File size:"
          ls -lh ~/private_keys/test_direct.p8
          
          echo ""
          echo "File content (first 100 chars):"
          head -c 100 ~/private_keys/test_direct.p8
          echo ""
          
      - name: Test with BASE64 DECODED
        run: |
          echo "=== Testing with BASE64 DECODED ==="
          mkdir -p ~/private_keys
          
          # Try to decode
          printf '%s' "${{ secrets.APPSTORE_API_KEY_P8 }}" | base64 -d > ~/private_keys/test_decoded.p8 2>&1 || echo "Base64 decode failed"
          
          echo "File size:"
          ls -lh ~/private_keys/test_decoded.p8 2>/dev/null || echo "File not created"
          
          echo ""
          echo "File content (first 100 chars):"
          head -c 100 ~/private_keys/test_decoded.p8 2>/dev/null || echo "Cannot read file"
          echo ""

      - name: Test each with app-store-connect
        run: |
          echo "=== Test 1: Direct format ==="
          app-store-connect apps list \
            --issuer-id "${{ secrets.APPSTORE_ISSUER_ID }}" \
            --key-id "${{ secrets.APPSTORE_KEY_ID }}" \
            --private-key ~/private_keys/test_direct.p8 \
            2>&1 | head -20 || true
          
          echo ""
          echo "=== Test 2: Base64 decoded format ==="
          app-store-connect apps list \
            --issuer-id "${{ secrets.APPSTORE_ISSUER_ID }}" \
            --key-id "${{ secrets.APPSTORE_KEY_ID }}" \
            --private-key ~/private_keys/test_decoded.p8 \
            2>&1 | head -20 || true
