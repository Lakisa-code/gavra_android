    final Uri url = Uri(scheme: 'tel', path: broj);
    try {
      if (await canLaunchUrl(url)) {
        await launchUrl(url);
      } else {
        throw 'Ne mogu pokrenuti poziv';
      }
    } catch (e) {
      if (mounted) {
        GavraUI.showSnackBar(
          context,
          message: GavraMessages.greskaPozivanje(broj),
          type: GavraNotificationType.error,
        );
      }
    }
  }

  /// ?? PrikaÅ¾i dijalog za unos plaÄ‡anja meseÄne karte
  Future<void> _prikaziPlacanje(RegistrovaniPutnik putnik) async {
    final result = await showDialog<Map<String, dynamic>>(
      context: context,
      builder: (ctx) {
        final iznosController = TextEditingController(
          text: putnik.cenaPoDanu?.toStringAsFixed(0) ?? '0',
        );
        String selectedMesec = _getDostupniMeseci().first;

        return AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          title: Text('PlaÄ‡anje: ${putnik.putnikIme}'),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              DropdownButtonFormField<String>(
                value: selectedMesec,
                decoration: const InputDecoration(labelText: GavraMessages.izaberiMesecLabel),
                items: _getDostupniMeseci()
                    .map((m) => DropdownMenuItem(value: m, child: Text(m)))
                    .toList(),
                onChanged: (val) => selectedMesec = val!,
              ),
              const SizedBox(height: 16),
              TextField(
                controller: iznosController,
                keyboardType: TextInputType.number,
                decoration: const InputDecoration(
                  labelText: 'Iznos (RSD)',
                  prefixIcon: Icon(Icons.payments_outlined),
                ),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              child: const Text(GavraMessages.odustani),
            ),
            ElevatedButton(
              onPressed: () => Navigator.pop(ctx, {
                'iznos': double.tryParse(iznosController.text) ?? 0.0,
                'mesec': selectedMesec,
              }),
              child: const Text('Potvrdi'),
            ),
          ],
        );
      },
    );

    if (result != null && mounted) {
      await _sacuvajPlacanje(
        putnikId: putnik.id,
        iznos: result['iznos'],
        mesec: result['mesec'],
        vozacIme: globalVozacIme,
      );
      
      // OsveÅ¾i plaÄ‡anja
      _ucitajSvePodatke([putnik]);
    }
  }

  /// ?? SaÄuvaj plaÄ‡anje u bazu (voznje_log)
  Future<void> _sacuvajPlacanje({
    required String putnikId,
    required double iznos,
    required String mesec,
    required String vozacIme,
  }) async {
    try {
      final parts = mesec.split(' ');
      final monthName = parts[0];
      final year = int.parse(parts[1]);

      await supabase.from('voznje_log').insert({
        'putnik_id': putnikId,
        'tip': 'uplata_mesecna',
        'iznos': iznos,
        'datum': DateTime.now().toIso8601String().split('T')[0],
        'napomena': 'Uplata za mesec: $monthName $year',
        'placeni_mesec': monthName,
        'placena_godina': year,
        'vozac': vozacIme,
      });

      if (mounted) {
        GavraUI.showSnackBar(
          context,
          message: GavraMessages.uspehPlacanje(iznos.toStringAsFixed(0)),
          type: GavraNotificationType.success,
        );
      }
    } catch (e) {
      if (mounted) {
        GavraUI.showSnackBar(
          context,
          message: 'GreÅ¡ka pri Äuvanju uplate: $e',
          type: GavraNotificationType.error,
        );
      }
    }
  }

  List<String> _getDostupniMeseci() {
    final now = DateTime.now();
    final List<String> options = [];
    
    // Aktuelni mesec i sledeÄ‡i
    options.add('${_getMonthNameStatic(now.month)} ${now.year}');
    
    DateTime next = DateTime(now.year, now.month + 1, 1);
    options.add('${_getMonthNameStatic(next.month)} ${next.year}');
    
    // ProÅ¡li mesec
    DateTime prev = DateTime(now.year, now.month - 1, 1);
    options.add('${_getMonthNameStatic(prev.month)} ${prev.year}');

    return options;
  }

  String _getMonthNameStatic(int month) {
    const months = ['', 'Januar', 'Februar', 'Mart', 'April', 'Maj', 'Jun', 'Jul', 'Avgust', 'Septembar', 'Oktobar', 'Novembar', 'Decembar'];
    if (month < 1 || month > 12) return '';
    return months[month];
  }

  /// ?? PrikaÅ¾i detaljne statistike koristeÄ‡i helper
  void _prikaziDetaljneStatistike(RegistrovaniPutnik putnik) {
    PutnikStatistikeHelper.prikaziDetaljneStatistike(
      context: context,
      putnikId: putnik.id,
      putnikIme: putnik.putnikIme,
      tip: putnik.tip,
      tipSkole: putnik.tipSkole,
      brojTelefona: putnik.brojTelefona,
      radniDani: putnik.radniDani,
      createdAt: putnik.createdAt,
      updatedAt: putnik.updatedAt,
      aktivan: putnik.aktivan,
    );
  }

  /// ?? Helper za graÄ‘enje input polja za vreme u "Add New" sekciji
  Widget _buildDanVremeInput(String dan) {
    final label = {'pon': 'Pon', 'uto': 'Uto', 'sre': 'Sre', 'cet': 'Cet', 'pet': 'Pet'}[dan] ?? dan;
    
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        children: [
          SizedBox(
            width: 40,
            child: Text(label, style: const TextStyle(fontWeight: FontWeight.bold)),
          ),
          Expanded(
            child: _buildTextField(
              controller: _getControllerBelaCrkva(dan),
              label: 'BC polazak',
              icon: Icons.access_time,
              keyboardType: TextInputType.datetime,
            ),
          ),
          const SizedBox(width: 8),
          Expanded(
            child: _buildTextField(
              controller: _getControllerVrsac(dan),
              label: 'VS polazak',
              icon: Icons.access_time,
              keyboardType: TextInputType.datetime,
            ),
          ),
        ],
      ),
    );
  }

  TextEditingController _getControllerBelaCrkva(String dan) => _polazakBcControllers[dan]!;
  TextEditingController _getControllerVrsac(String dan) => _polazakVsControllers[dan]!;
}
